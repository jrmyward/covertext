# Copy this file to .kamal/secrets.staging and .kamal/secrets.production
# DO NOT commit secrets.* files to git!
#
# Kamal uses destination-specific secret files:
# - .kamal/secrets.staging (used with: kamal deploy -d staging)
# - .kamal/secrets.production (used with: kamal deploy -d production)

# For .kamal/secrets.staging:
# SECRETS=$(kamal secrets fetch --adapter 1password --account YOUR_1PASSWORD_ACCOUNT_ID --from CoverText/Staging KAMAL_REGISTRY_PASSWORD RAILS_MASTER_KEY POSTGRES_PASSWORD)

# For .kamal/secrets.production:
# SECRETS=$(kamal secrets fetch --adapter 1password --account YOUR_1PASSWORD_ACCOUNT_ID --from CoverText/Production KAMAL_REGISTRY_PASSWORD RAILS_MASTER_KEY)

# Fetch secrets from 1Password (update vault path for each environment)
# Staging needs POSTGRES_PASSWORD for the accessory
# Production doesn't need POSTGRES_PASSWORD (using managed Postgres)
SECRETS=$(kamal secrets fetch --adapter 1password --account YOUR_1PASSWORD_ACCOUNT_ID --from CoverText/ENVIRONMENT KAMAL_REGISTRY_PASSWORD RAILS_MASTER_KEY)
KAMAL_REGISTRY_PASSWORD=$(kamal secrets extract KAMAL_REGISTRY_PASSWORD ${SECRETS})
RAILS_MASTER_KEY=$(kamal secrets extract RAILS_MASTER_KEY ${SECRETS})

# For staging only: extract POSTGRES_PASSWORD
# POSTGRES_PASSWORD=$(kamal secrets extract POSTGRES_PASSWORD ${SECRETS})

# Database credentials are accessed via Rails.application.credentials.dig(:database, :password)
# from environment-specific credentials files (config/credentials/staging.yml.enc, production.yml.enc)

# ─────────────────────────────────────────────────────────────────
# 1Password Setup Instructions:
# ─────────────────────────────────────────────────────────────────
# 1. Create two vaults in 1Password:
#    - CoverText/Staging
#    - CoverText/Production
#
# 2. In each vault, add items for:
#    - KAMAL_REGISTRY_PASSWORD (GitHub PAT with write:packages scope)
#    - RAILS_MASTER_KEY (from config/credentials/staging.key or production.key)
#
# 3. Database credentials should be stored in Rails encrypted credentials:
#    bin/rails credentials:edit --environment staging
#    bin/rails credentials:edit --environment production
#
#    Add to each credentials file:
#    database:
#      password: your_postgres_password_here
#      # Or for production with managed Postgres:
#      url: postgres://user:pass@host:25060/db?sslmode=require
# ─────────────────────────────────────────────────────────────────
