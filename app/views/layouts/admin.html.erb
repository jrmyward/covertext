<!DOCTYPE html>
<html class="h-full bg-base-200">
  <head>
    <title><%= content_for(:title) || "Admin - CoverText" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="CoverText">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag :tailwind, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="h-full">
    <div class="flex h-full">
      <!-- Sidebar -->
      <aside class="hidden w-64 flex-col border-r border-base-300 bg-base-100 lg:flex">
        <!-- CoverText Branding -->
        <div class="flex h-16 items-center justify-between border-b border-base-300 px-5">
          <%= link_to "CoverText", admin_dashboard_path, class: "text-xl font-bold text-primary" %>
        </div>

        <!-- Navigation Menu -->
        <nav class="flex-1 overflow-y-auto py-4">
          <ul class="menu menu-sm px-2">
            <li><%= link_to admin_dashboard_path, class: "menu-item #{current_page?(admin_dashboard_path) ? 'active' : ''}" do %>
              <span class="size-5"><%= heroicon "home", variant: :mini %></span>
              <span>Dashboard</span>
            <% end %></li>
            <li class="<%= 'disabled' unless current_agency&.phone_ready? %>">
              <%= link_to admin_requests_path, 
                  class: "menu-item #{current_page?(admin_requests_path) ? 'active' : ''} #{current_agency&.phone_ready? ? '' : 'opacity-50 cursor-not-allowed'}",
                  onclick: (current_agency&.phone_ready? ? nil : 'return false;') do %>
                <span class="size-5"><%= heroicon "inbox", variant: :mini %></span>
                <span>Requests</span>
              <% end %>
            </li>
            <li><%= link_to admin_billing_path, class: "menu-item" do %>
              <span class="size-5"><%= heroicon "credit-card", variant: :mini %></span>
              <span>Billing</span>
            <% end %></li>
            <li><%= link_to admin_account_path, class: "menu-item" do %>
              <span class="size-5"><%= heroicon "cog-6-tooth", variant: :mini %></span>
              <span>Account Settings</span>
            <% end %></li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <div class="flex min-w-0 flex-1 flex-col">
        <!-- Top Bar -->
        <header class="flex h-16 items-center justify-between border-b border-base-300 bg-base-100 px-4 lg:px-6">
          <!-- Left: Mobile menu + Greeting -->
          <div class="flex items-center gap-2 sm:gap-3">
            <!-- Mobile menu button -->
            <button class="btn btn-ghost btn-sm lg:hidden">
              <span class="size-6"><%= heroicon "bars-3" %></span>
            </button>

            <!-- Greeting -->
            <div>
              <p class="font-medium leading-none md:text-lg">
                Good <%= Time.current.hour < 12 ? 'Morning' : Time.current.hour < 18 ? 'Afternoon' : 'Evening' %>
                <span class="max-sm:hidden">, <%= current_user.first_name %>!</span>
              </p>
              <p class="mt-1 text-sm/none text-base-content/60 max-sm:hidden">
                <%= current_account.name %> Â· <%= current_account.plan_name&.titleize || 'Basic' %> Plan
              </p>
            </div>
          </div>

          <!-- Right: User dropdown -->
          <div class="dropdown dropdown-end">
            <button tabindex="0" class="btn btn-ghost gap-2 hover:bg-base-200">
              <div class="avatar bg-secondary text-primary-content rounded-lg w-8 h-8 flex items-center justify-center">
                <span class="text-xl"><%= current_user.first_name[0] %><%= current_user.last_name[0] %></span>
              </div>
              <div class="text-left max-lg:hidden">
                <p class="text-sm font-medium leading-none"><%= current_user.first_name %> <%= current_user.last_name %></p>
                <p class="mt-0.5 text-xs text-base-content/60"><%= current_user.email %></p>
              </div>
              <span class="size-5 text-base-content/60 max-lg:hidden">
                <%= heroicon "chevron-down", variant: :mini %>
              </span>
            </button>
            <ul tabindex="0" class="menu dropdown-content rounded-box z-50 mt-3 w-56 bg-base-100 p-2 shadow-lg">
              <li class="menu-title px-4 py-2">
                <span class="text-xs font-semibold"><%= current_user.role.titleize %></span>
              </li>
              <li><%= link_to admin_account_path do %>
                <span class="size-5"><%= heroicon "cog-6-tooth", variant: :mini %></span>
                <span>Account Settings</span>
              <% end %></li>
              <li><%= link_to admin_billing_path do %>
                <span class="size-5"><%= heroicon "credit-card", variant: :mini %></span>
                <span>Billing</span>
              <% end %></li>
              <div class="divider my-1"></div>
              <li><%= link_to logout_path, data: { turbo_method: :delete }, class: "text-error" do %>
                <span class="size-5"><%= heroicon "arrow-right-on-rectangle", variant: :mini %></span>
                <span>Sign Out</span>
              <% end %></li>
            </ul>
          </div>
        </header>

        <!-- Flash Messages -->
        <% if flash[:notice] %>
          <div class="alert alert-success m-4 rounded-lg">
            <span class="size-6 shrink-0"><%= heroicon "check-circle" %></span>
            <span><%= flash[:notice] %></span>
          </div>
        <% end %>

        <% if flash[:alert] %>
          <div class="alert alert-error m-4 rounded-lg">
            <span class="size-6 shrink-0"><%= heroicon "exclamation-circle" %></span>
            <span><%= flash[:alert] %></span>
          </div>
        <% end %>

        <!-- Grace Period Warning Banner -->
        <% if current_account&.in_grace_period? && !session[:grace_period_banner_dismissed] %>
          <div id="grace-period-banner" class="alert alert-warning m-4 rounded-lg">
            <span class="size-6 shrink-0"><%= heroicon "exclamation-triangle" %></span>
            <div class="flex-1">
              <h3 class="font-bold">Subscription Expiring</h3>
              <p class="text-sm">
                Your subscription will end in <%= pluralize(current_account.days_until_lockout, 'day') %>.
                <%= link_to "Update billing", admin_billing_path, class: "link link-hover font-semibold" %> to continue service.
              </p>
            </div>
            <button
              data-action="click->admin-banner#dismiss"
              data-url="<%= admin_dismiss_grace_period_banner_path %>"
              class="btn btn-ghost btn-sm">
              Dismiss
            </button>
          </div>
        <% end %>

        <!-- Page Content -->
        <main class="flex-1 overflow-auto p-4 lg:p-6">
          <%= yield %>
        </main>
      </div>
    </div>
  </body>
</html>
