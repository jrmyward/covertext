<!DOCTYPE html>
<html>
  <head>
    <title>CoverText Admin</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="min-h-screen bg-base-200">
    <div class="navbar bg-base-100 shadow-lg">
      <div class="flex-1">
        <a href="<%= admin_requests_path %>" class="btn btn-ghost text-xl">CoverText Admin</a>
      </div>
      <div class="flex-none gap-2">
        <% if current_user.owner? %>
          <%= link_to "Account", admin_account_path, class: "btn btn-ghost btn-sm" %>
        <% end %>
        <%= link_to "Billing", admin_billing_path, class: "btn btn-ghost btn-sm" %>
        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost">
            <%= current_user.first_name %> <%= current_user.last_name %>
            <span class="badge badge-sm"><%= current_agency.name %></span>
          </div>
          <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
            <li><%= button_to "Logout", logout_path, method: :delete, class: "text-error" %></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Subscription & Live Status Banner -->
    <% if current_agency && current_agency.account %>
      <% if current_agency.account.in_grace_period? && !session[:grace_period_banner_dismissed] %>
        <div class="alert alert-warning" id="grace-period-banner" data-controller="banner">
          <div class="flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 mx-2 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
              <strong>Subscription Expiring:</strong> Your subscription ends in <%= current_agency.account.days_until_lockout %> day<%= current_agency.account.days_until_lockout == 1 ? '' : 's' %>. Your account is currently read-only.
              <%= link_to "Update Billing", admin_billing_path, class: "btn btn-sm btn-warning ml-2" %>
            </div>
          </div>
          <button type="button" class="btn btn-ghost btn-sm" data-action="click->banner#dismiss" data-banner-url="<%= admin_dismiss_grace_period_banner_path %>">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      <% elsif !current_agency.account.subscription_active? && !current_agency.account.in_grace_period? %>
        <div class="alert alert-error">
          <div class="flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 mx-2 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>
            <div>
              <strong>Subscription Issue:</strong> Your subscription is <%= current_agency.account.subscription_status || 'inactive' %>.
              <%= link_to "Update Billing", admin_billing_path, class: "btn btn-sm btn-error ml-2" %>
            </div>
          </div>
        </div>
      <% end %>

      <% if current_agency.account.subscription_active? && !current_agency.live_enabled? %>
        <div class="alert alert-info">
          <div class="flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 mx-2 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <strong>Your account is active, but not yet live.</strong>
              Contact us to activate messaging and start serving clients.
              <a href="mailto:hello@covertext.io?subject=Activate%20My%20Agency" class="btn btn-sm btn-info ml-2">Contact Us</a>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>

    <div class="container mx-auto px-4 py-8">
      <% if flash[:notice] %>
        <div class="alert alert-success mb-4">
          <span><%= flash[:notice] %></span>
        </div>
      <% end %>

      <% if flash[:alert] %>
        <div class="alert alert-error mb-4">
          <span><%= flash[:alert] %></span>
        </div>
      <% end %>

      <%= yield %>
    </div>
  </body>
</html>
