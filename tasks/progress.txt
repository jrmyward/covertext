## Codebase Patterns
- Use `DATABASE_URL="postgres://jward@localhost/covertext_test"` for local development (Docker config uses "postgres" host which doesn't work outside container)
- Account model follows same validation patterns as Agency (stripe_*_id unique allow_nil, subscription_status with inclusion validation)
- Stripe billing fields (stripe_customer_id, stripe_subscription_id, subscription_status, plan_name) are now on Account, not Agency
- When creating Agency, always provide an Account; signup flow creates Account + Agency + User together
- Billing views/controllers should use @account for subscription info, @agency only for live_enabled status
- User belongs_to :account (not agency); Agency no longer has_many :users
- Signup creates owner role; admin is the default role
- Use `current_user.account.agencies.where(active: true).first` to get current_agency

---

## 2026-01-31 - US-001
Thread: https://ampcode.com/threads/T-019c164b-fdbb-739c-9338-1995d473784f
- Created Account model with name, stripe_customer_id, stripe_subscription_id, subscription_status, plan_name
- Added migration with unique indexes on stripe_customer_id and stripe_subscription_id
- Account has_many :agencies, has_many :users associations
- Created comprehensive model tests (11 tests)
- Files changed:
  - app/models/account.rb (new)
  - db/migrate/20260131230357_create_accounts.rb (new)
  - test/models/account_test.rb (new)
- **Learnings for future iterations:**
  - Database connection configured for Docker; use DATABASE_URL env var for local development
  - Follow existing validation patterns from Agency model for consistency
  - All CI checks pass: tests (170), rubocop, brakeman
---

## 2026-01-31 - US-002
Thread: https://ampcode.com/threads/T-019c1676-e016-764d-a32f-d16a70708e8b
- Added `account_id` foreign key to agencies table (not null, with foreign key constraint)
- Removed Stripe billing columns from agencies (stripe_customer_id, stripe_subscription_id, subscription_status, plan_name)
- Added `active` boolean column to agencies (default: true)
- Agency now `belongs_to :account`
- Updated billing views/controller to use @account for subscription info
- Updated RegistrationsController to create Account + Agency + User in transaction
- Updated test fixtures and all tests referencing old agency Stripe fields
- Files changed:
  - db/migrate/20260131231104_add_account_id_to_agencies.rb (new)
  - app/models/agency.rb (modified - added belongs_to :account, can_go_live?)
  - app/models/account.rb (modified - temporarily removed has_many :users until US-003)
  - app/controllers/registrations_controller.rb (modified - creates Account first)
  - app/controllers/admin/billing_controller.rb (unchanged - already used @account)
  - app/views/admin/billing/show.html.erb (modified - use @account for billing fields)
  - db/seeds.rb (modified - creates Account before Agency)
  - test/fixtures/accounts.yml (new)
  - test/fixtures/agencies.yml (modified - references accounts)
  - Multiple test files updated to use Account for Stripe fields
- **Learnings for future iterations:**
  - Account's `has_many :users` can't exist until users table has account_id (US-003)
  - Tests that create agencies ad-hoc must also create an Account first
  - The signup flow now creates Account + Agency together, not just Agency
  - All CI checks pass: tests (168), rubocop, brakeman
---

## 2026-02-01 - US-003
Thread: https://ampcode.com/threads/T-019c1680-1cd1-7204-ab75-75a8ccc2a27c
- Added `account_id` foreign key to users table (not null)
- Removed `agency_id` foreign key from users table
- User now `belongs_to :account` instead of `belongs_to :agency`
- Account now `has_many :users` (was commented out pending this migration)
- Agency no longer `has_many :users`
- Updated RegistrationsController to create user under account with 'owner' role
- Updated Admin::BaseController.current_agency to use account.agencies.where(active: true).first
- Updated Admin::BillingController to use current_user.account
- Updated all fixtures: john_admin → john_owner, agency → account references
- Files changed:
  - db/migrate/20260201000038_move_user_from_agency_to_account.rb (new)
  - app/models/user.rb (modified - belongs_to :account, added ROLES constant)
  - app/models/account.rb (modified - has_many :users)
  - app/models/agency.rb (modified - removed has_many :users)
  - app/controllers/registrations_controller.rb (modified - user belongs to account)
  - app/controllers/admin/base_controller.rb (modified - current_agency from account)
  - app/controllers/admin/billing_controller.rb (modified - use current_user.account)
  - test/fixtures/users.yml (modified - account references)
  - Multiple test files updated for john_owner fixture name
- **Learnings for future iterations:**
  - Fixture renames require updating ALL test references
  - Agency.has_many :users was causing "agency_id does not exist" errors in seed tests
  - Admin controllers must get agency through account, not directly from user
  - All CI checks pass: tests (168), rubocop, brakeman
---

## 2026-02-01 - US-004
Thread: https://ampcode.com/threads/T-019c168c-efe5-721c-8a3a-bbe30b4a7489
- Implemented `Account#subscription_active?` (already existed, added tests)
- Implemented `Account#has_active_agency?` using `agencies.exists?(active: true)`
- Implemented `Account#can_access_system?` combining subscription and agency checks
- Implemented `Account#owner` returning user with role 'owner'
- Added 11 comprehensive tests for all new methods
- Files changed:
  - app/models/account.rb (modified - added has_active_agency?, can_access_system?, owner)
  - test/models/account_test.rb (modified - added tests for all methods)
- **Learnings for future iterations:**
  - Use `agencies.exists?(active: true)` for efficient existence checks
  - Test fixtures provide ready-made data for testing relationships
  - All CI checks pass: tests (180), rubocop, brakeman
---

## 2026-02-01 - US-005
Thread: https://ampcode.com/threads/T-019c1693-3a44-70b3-ae61-79563fa20178
- Implemented `Agency#activate!` method to set active: true
- Implemented `Agency#deactivate!` method to set active: false
- `can_go_live?` already existed from US-002
- No `subscription_active?` method existed on Agency (only on Account) - no removal needed
- Added 2 unit tests for activate! and deactivate!
- Files changed:
  - app/models/agency.rb (modified - added activate!, deactivate!)
  - test/models/agency_test.rb (modified - added tests for new methods)
- **Learnings for future iterations:**
  - Agency never had `subscription_active?` - billing was moved to Account in US-002
  - Simple update! methods follow Rails convention with bang suffix
  - All CI checks pass: tests (182), rubocop, brakeman
---

## 2026-02-01 - US-006
Thread: https://ampcode.com/threads/T-019c1694-9bd5-7470-a57d-16b3624d791f
- Verified test fixtures are already complete from US-002 and US-003
- accounts.yml: contains reliable_group and acme_group test accounts
- agencies.yml: agencies reference accounts via `account:` association
- users.yml: users reference accounts (not agencies) with proper roles
- All 182 tests pass, rubocop and brakeman clean
- Files verified:
  - test/fixtures/accounts.yml (created in US-002)
  - test/fixtures/agencies.yml (updated in US-002)
  - test/fixtures/users.yml (updated in US-003)
- **Learnings for future iterations:**
  - Fixtures were incrementally updated as models evolved
  - No additional changes needed when acceptance criteria is already satisfied
  - All CI checks pass: tests (182), rubocop, brakeman
---

## 2026-02-01 - US-007
Thread: https://ampcode.com/threads/T-019c16a3-deae-77fe-b8e4-88f2684644cf
- Seeds.rb was already correctly updated in US-002 with multitenancy hierarchy
- Updated seed_test.rb and seeds_test.rb to expect 2 agencies (not 1)
- Tests now verify: 1 Account, 2 Agencies, 1 User (owner), 4 Clients, 10 Policies, 10 Documents
- Files changed:
  - test/models/seed_test.rb (modified - updated expectations for 2 agencies)
  - test/models/seeds_test.rb (modified - updated expectations for 2 agencies)
- **Learnings for future iterations:**
  - There are two duplicate seed test files (seed_test.rb and seeds_test.rb) - both need updates
  - When PRD specifies new data model with 2 agencies, existing tests expecting 1 agency need updating
  - All CI checks pass: tests (182), rubocop, brakeman
---

## 2026-01-31 - US-008
Thread: https://ampcode.com/threads/T-019c16aa-5aa9-7274-92b8-c1799f87ba8c
- Added `current_account` helper method to ApplicationController (returns `current_user&.account`)
- Added `require_active_subscription` before_action to ApplicationController
- Redirects to billing page with message when subscription inactive
- Redirects to billing page with message when no active agencies
- Updated Admin::BaseController to include `require_active_subscription` filter
- Updated Admin::BillingController to inherit from BaseController and skip the subscription check
- Created 4 integration tests for subscription access control
- Files changed:
  - app/controllers/application_controller.rb (modified - added current_account, require_active_subscription)
  - app/controllers/admin/base_controller.rb (modified - added require_active_subscription before_action)
  - app/controllers/admin/billing_controller.rb (modified - inherit from BaseController, skip subscription check)
  - test/controllers/application_controller_test.rb (new - 4 tests)
- **Learnings for future iterations:**
  - BillingController must skip subscription check so users can access billing to fix issues
  - The billing page is the appropriate redirect target for both subscription and agency issues
  - All CI checks pass: tests (186), rubocop, brakeman
---

## 2026-01-31 - US-009
Thread: https://ampcode.com/threads/T-019c16b1-1909-760f-9b09-49db916f9190
- Verified all acceptance criteria already met from US-003 and US-008:
  - `current_account` helper in ApplicationController (inherited by BaseController)
  - `current_agency` in BaseController returns `current_user.account.agencies.where(active: true).first`
  - BillingController and RequestsController both inherit from BaseController
- No code changes needed - implementation complete from prior stories
- Files verified:
  - app/controllers/application_controller.rb (current_account helper)
  - app/controllers/admin/base_controller.rb (current_agency helper)
  - app/controllers/admin/billing_controller.rb (inherits BaseController)
  - app/controllers/admin/requests_controller.rb (uses current_agency)
- **Learnings for future iterations:**
  - Some stories may be satisfied by earlier work - verify before implementing
  - All CI checks pass: tests (186), rubocop, brakeman
---
